<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD - INTERFACE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Gerenciador de Itens</h1>

        <div id="message" class="message" style="display: none;"></div>

        <div class="form-group">
            <label for="itemName">Nome do Item:</label>
            <input type="text" id="itemName" placeholder="Digite o nome do item...">
        </div>

        <div class="form-group">
            <label for="itemQuantidade">Quantidade:</label>
            <input type="number" id="itemQuantidade" placeholder="Quantidade em estoque..." value="0" min="0">
        </div>

        <div class="form-group">
            <button class="btn btn-primary" onclick="addItem()">Adicionar Item</button>
            <button class="btn btn-secondary" onclick="loadItems()">Atualizar Lista</button>
            <button class="btn btn-secondary" onclick="clearForm()">Limpar</button>
        </div>

        <div class="items-list">
            <h2>Itens Cadastrados</h2>
            <div id="itemsContainer" class="loading">
                Clique em "Atualizar Lista" para carregar os itens...
            </div>
        </div>
    </div>

    <script>
        let editingItemId = null;

        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }

        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantidade').value = '0';
            editingItemId = null;
            showMessage('Formulário limpo!', 'success');
        }

        async function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const quantidadeInput = document.getElementById('itemQuantidade').value;
            const quantidade = quantidadeInput ? parseInt(quantidadeInput) : 0;

            if (!name) {
                showMessage('Por favor, digite um nome para o item!', 'error');
                return;
            }

            console.log('Enviando:', { name, quantidade }); // Debug

            try {
                const response = await fetch('http://localhost:3005/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, quantidade: quantidade })
                });

                if (response.ok) {
                    showMessage('Item adicionado com sucesso!');
                    clearForm();
                    loadItems();
                } else {
                    showMessage('Erro ao adicionar item!', 'error');
                }
            } catch (error) {
                showMessage('Erro de conexão!', 'error');
                console.error('Error:', error);
            }
        }

        async function loadItems() {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '<div class="loading">Carregando itens...</div>';

            try {
                const response = await fetch('http://localhost:3005/items');
                const items = await response.json();

                if (items.length === 0) {
                    container.innerHTML = '<div class="loading">Nenhum item cadastrado.</div>';
                    return;
                }

                let html = '';
                items.forEach(item => {
                    const estoqueClass = item.quantidade < 10 ? 'estoque-baixo' : '';
                    const estoqueStatus = item.quantidade < 10 ? '⚠️ ESTOQUE BAIXO' : '✓ Estoque OK';
                    html += `
                        <div class="item-card ${estoqueClass}">
                            <div class="item-info">
                                <div><strong>ID: ${item.id}</strong> - ${item.name}</div>
                                <div class="quantidade">Quantidade: <strong>${item.quantidade}</strong> unidades ${item.quantidade < 10 ? '- ' + estoqueStatus : ''}</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-secondary" onclick="editItem(${item.id}, '${item.name.replace(/'/g, "\\'")}', ${item.quantidade})">
                                    Editar
                                </button>
                                <button class="btn btn-danger" onclick="deleteItem(${item.id})">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                showMessage('Lista atualizada!');

            } catch (error) {
                container.innerHTML = '<div class="loading error">Erro ao carregar itens.</div>';
                showMessage('Erro ao carregar itens!', 'error');
                console.error('Error:', error);
            }
        }

        function editItem(id, name, quantidade) {
            document.getElementById('itemName').value = name;
            document.getElementById('itemQuantidade').value = quantidade;
            editingItemId = id;
            showMessage(`Editando item ID: ${id} - Clique em "Atualizar Item" para salvar.`);
            
            const addButton = document.querySelector('.btn-primary');
            addButton.textContent = 'Atualizar Item';
            addButton.onclick = updateItem;
        }

        async function updateItem() {
            if (!editingItemId) {
                showMessage('Nenhum item selecionado para edição!', 'error');
                return;
            }

            const name = document.getElementById('itemName').value.trim();
            const quantidadeInput = document.getElementById('itemQuantidade').value;
            const quantidade = quantidadeInput ? parseInt(quantidadeInput) : 0;
            
            if (!name) {
                showMessage('Por favor, digite um nome para o item!', 'error');
                return;
            }

            console.log('Atualizando:', { name, quantidade }); // Debug

            try {
                const response = await fetch(`http://localhost:3005/items/${editingItemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, quantidade: quantidade })
                });

                if (response.ok) {
                    showMessage('Item atualizado com sucesso!');
                    clearForm();
                    loadItems();
                    
                    const addButton = document.querySelector('.btn-primary');
                    addButton.textContent = 'Adicionar Item';
                    addButton.onclick = addItem;
                } else {
                    showMessage('Erro ao atualizar item!', 'error');
                }
            } catch (error) {
                showMessage('Erro de conexão!', 'error');
                console.error('Error:', error);
            }
        }

        async function deleteItem(id) {
            if (!confirm('Tem certeza que deseja excluir este item?')) return;

            try {
                const response = await fetch(`http://localhost:3005/items/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Item excluído com sucesso!');
                    loadItems();
                } else {
                    showMessage('❌ Erro ao excluir item!', 'error');
                }
            } catch (error) {
                showMessage('❌ Erro de conexão!', 'error');
                console.error('Error:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadItems();
        });
    </script>
</body>
</html>